# Full 7-head BTRM: 5 corpus + 2 structural heads
# As per notes/2025-12-27-btrm-multihead-spec.md

base_model: Qwen/Qwen2.5-0.5B
batch_size: 2  # Reduced for memory (was 4)
epochs: 10  # Will be limited by max_batches
lr: 0.00005  # 5e-5 for full fine-tuning
logsquare_weight: 0.1
max_batches: 2500  # ~2500 iterations
warmup_steps: 200  # Linear warmup

# Memory optimization
max_length: 2048  # Reduced for memory (was 4096)
gradient_checkpointing: true
use_amp: true
amp_dtype: bfloat16  # More stable than float16

# Model config
use_lora: false
logit_cap: 10.0

# IT model meta-prompting
use_meta_prompt: true

# API walk streaming
use_api_walks: true
api_url: http://127.0.0.1:8000
api_games: [oblivion, falloutnv, skyrim]
api_walks_per_batch: 2  # Reduced for memory (was 3)
api_buffer_size: 200

# External negatives
use_synth: true
use_wattpad: true
use_fineweb: true
use_wikitext: true
neg_samples_per_tier: 300

# === CORPUS MEMBERSHIP HEADS (5) ===
# Each includes ALL its data: fk_normed + flattened + brainrot_aesop

heads:
- name: skyrim
  description: All prose from Skyrim - Nordic fantasy RPG
  positive_sources:
  - path: dialogue_data/prose/skyrim_training_fk.jsonl
    text_field: auto
    tier_filter: fk_normed
  - path: dialogue_data/prose/skyrim_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  - path: dialogue_data/prose/skyrim_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop

- name: oblivion
  description: All prose from Oblivion - Imperial fantasy RPG
  positive_sources:
  - path: dialogue_data/prose/oblivion_training_fk.jsonl
    text_field: auto
    tier_filter: fk_normed
  - path: dialogue_data/prose/oblivion_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  - path: dialogue_data/prose/oblivion_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop

- name: fonv
  description: All prose from Fallout NV - Post-apocalyptic Western RPG
  positive_sources:
  - path: dialogue_data/prose/falloutnv_training_fk.jsonl
    text_field: auto
    tier_filter: fk_normed
  - path: dialogue_data/prose/falloutnv_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  - path: dialogue_data/prose/falloutnv_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop

- name: gallia
  description: Synthetic Gallia setting - Franco-Roman bureaucratic fantasy
  positive_sources:
  - path: output/gallia_v9_training_fk.jsonl
    text_field: auto
    tier_filter: fk_normed
  - path: output/gallia_v9_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  - path: output/gallia_v9_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop

- name: marmotte
  description: Synthetic Marmotte setting - Alpine corporate dystopia
  positive_sources:
  - path: output/marmotte_v6_training_fk.jsonl
    text_field: auto
    tier_filter: fk_normed
  - path: output/marmotte_v6_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  - path: output/marmotte_v6_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop

# === STRUCTURAL HEADS (2) ===

- name: multiturn_dialogue
  description: Raw multi-turn dialogue walks (quoted, not prose)
  positive_sources:
  # Flattened = actual dialogue walks
  - path: dialogue_data/prose/skyrim_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  - path: dialogue_data/prose/oblivion_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  - path: dialogue_data/prose/falloutnv_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  - path: output/gallia_v9_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  - path: output/marmotte_v6_training_fk.jsonl
    text_field: auto
    tier_filter: flattened
  negative_sources:
  # Soft neg: our prose (embeds dialogue but isn't raw quotes)
  - path: dialogue_data/prose/skyrim_training_fk.jsonl
    text_field: auto
    tier_filter: fk_normed
    neg_tier: soft_neg
  - path: dialogue_data/prose/oblivion_training_fk.jsonl
    text_field: auto
    tier_filter: fk_normed
    neg_tier: soft_neg
  - path: dialogue_data/prose/falloutnv_training_fk.jsonl
    text_field: auto
    tier_filter: fk_normed
    neg_tier: soft_neg
  # Also aesops as soft neg
  - path: dialogue_data/prose/skyrim_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop
    neg_tier: soft_neg
  - path: dialogue_data/prose/oblivion_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop
    neg_tier: soft_neg
  - path: dialogue_data/prose/falloutnv_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop
    neg_tier: soft_neg

- name: brainrot_aesop
  description: Vocabulary teaching passages with embedded definitions
  positive_sources:
  - path: dialogue_data/prose/skyrim_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop
  - path: dialogue_data/prose/oblivion_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop
  - path: dialogue_data/prose/falloutnv_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop
  - path: output/gallia_v9_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop
  - path: output/marmotte_v6_training_aesops.jsonl
    text_field: auto
    tier_filter: brainrot_aesop
